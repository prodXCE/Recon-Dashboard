<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scan Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f8f9fa; color: #212529; }
        h1, h2 { color: #343a40; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; background-color: #fff; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #dee2e6; text-align: left; padding: 12px; }
        th { background-color: #e9ecef; }
        .info-section { background-color: #fff; padding: 20px; border-radius: 8px; margin-top: 2em; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        #loading-indicator { text-align: center; font-size: 1.5em; padding: 40px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Scan Results</h1>

    <div id="loading-indicator">
        <p>ðŸš€ Scan in progress... Please wait.</p>
    </div>

    <div id="results-container" class="hidden"></div>

    <script>
        const task_id = "{{ task_id }}";
        const resultsContainer = document.getElementById('results-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        function buildNmapTable(ports) {
            let table = '<table><thead><tr><th>Port</th><th>Protocol</th><th>State</th><th>Service</th><th>Product</th></tr></thead><tbody>';
            ports.forEach(port => {
                table += `<tr><td>${port.port}</td><td>${port.protocol}</td><td>${port.state}</td><td>${port.service}</td><td>${port.product}</td></tr>`;
            });
            table += '</tbody></table>';
            return table;
        }

        function buildWhoisTable(whoisData) {
            let table = '<table><tbody>';
            for (const [key, value] of Object.entries(whoisData)) {
                table += `<tr><td><strong>${key.replace(/_/g, ' ').toUpperCase()}</strong></td><td>${Array.isArray(value) ? value.join(', ') : value}</td></tr>`;
            }
            table += '</tbody></table>';
            return table;
        }
        
        function buildDnsTable(dnsData) {
            let table = '<table><tbody>';
            for (const [key, value] of Object.entries(dnsData)) {
                table += `<tr><td><strong>${key}</strong></td><td>${value.join(', ')}</td></tr>`;
            }
            table += '</tbody></table>';
            return table;
        }

        function buildShodanTable(shodanData) {
        if (shodanData.error) {
            return `<p><strong>Shodan Error:</strong> ${shodanData.error}</p>`;
        }
        let table = '<table><tbody>';
        table += `<tr><td><strong>Country</strong></td><td>${shodanData.country}</td></tr>`;
        table += `<tr><td><strong>City</strong></td><td>${shodanData.city}</td></tr>`;
        table += `<tr><td><strong>ISP</strong></td><td>${shodanData.isp}</td></tr>`;
        table += `<tr><td><strong>OS</strong></td><td>${shodanData.os}</td></tr>`;
        table += `<tr><td><strong>Hostnames</strong></td><td>${shodanData.hostnames.join(', ') || 'N/A'}</td></tr>`;
        table += `<tr><td><strong>Open Ports (from Shodan)</strong></td><td>${shodanData.ports.join(', ') || 'N/A'}</td></tr>`;
        table += '</tbody></table>';
        return table;
        }


        function displayResults(data) {
            loadingIndicator.classList.add('hidden');
            resultsContainer.classList.remove('hidden');

            let html = '';
            if (data.shodan) {
                 html += '<div class="info-section"><h2>Shodan Information</h2>' + buildShodanTable(data.shodan) + '</div>';
            }
            if (data.nmap) {
                html += '<div class="info-section"><h2>Nmap Scan</h2>' + buildNmapTable(data.nmap) + '</div>';
            }
            if (data.whois) {
                html += '<div class="info-section"><h2>WHOIS Information</h2>' + buildWhoisTable(data.whois) + '</div>';
            }
            if (data.dns) {
                html += '<div class="info-section"><h2>DNS Records</h2>' + buildDnsTable(data.dns) + '</div>';
            }
            if (data.error) {
                html += `<div class="info-section"><h2>Error</h2><p>${data.error}</p></div>`;
            }
            html += '<br><a href="/">Scan Another Target</a>';
            resultsContainer.innerHTML = html;
        }

        const interval = setInterval(() => {
            fetch(`/status/${task_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'complete') {
                        clearInterval(interval);
                        displayResults(data.data);
                    }
                })
                .catch(error => {
                    console.error('Error polling for status:', error);
                    clearInterval(interval);
                    loadingIndicator.innerHTML = '<p>Error retrieving results.</p>';
                });
        }, 3000); 
    </script>
</body>
</html>